version: "3.9"

services:
  mysql_gitgrade:
    image: mysql:8.1.0
    restart: unless-stopped
    environment:
      - TZ=$APP_TIMEZONE
      - MYSQL_DATABASE=$DB_NAME
      - MYSQL_ROOT_PASSWORD=$DB_PASSWORD
      - MYSQL_PASSWORD=$DB_PASSWORD
    ports:
      - $DB_PORT:$DB_DOCKER_PORT
    volumes:
      - gitgrade-mysql-data:/var/lib/mysql
    networks:
      - gitgrade-network
    env_file:
      - .env

  jobscheduler-service:
    build:
      context: ./jobscheduler-service/
      dockerfile: Dockerfile
    working_dir: /usr/src/gitgrade/jobscheduler_service/
    restart: unless-stopped
    depends_on:
      - mysql_gitgrade
    environment:
      - TZ=$APP_TIMEZONE
      - DB_HOST=mysql_gitgrade
      - DB_USER=$DB_USER
      - DB_PASSWORD=$DB_PASSWORD
      - DB_NAME=$DB_NAME
      - DB_PORT=$DB_DOCKER_PORT
      - PORT=$JOBSCHEDULER_SERVICE_NODE_PORT
      - NODE_ENV=$NODE_ENV
      - APP_TIMEZONE=$APP_TIMEZONE
      - DB_DIALECT=$DB_DIALECT
      - DB_CHARSET=$DB_CHARSET
      - DB_COLLATE=$DB_COLLATE
      - DB_TIMEZONE=$DB_TIMEZONE
      - SYNC_TIME=$SYNC_TIME
      - APP_DEBUG=$APP_DEBUG
      - GITHUB_PERSONAL_ACCESS_TOKEN=$GITHUB_PERSONAL_ACCESS_TOKEN
      - GITHUB_ORGANIZATION_NAME=$GITHUB_ORGANIZATION_NAME
      - TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN
      - TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID
    command: /bin/bash -c "./wait-for-it.sh --timeout=600 mysql_gitgrade:$DB_DOCKER_PORT && npm run start:prod"
    ports:
      - $JOBSCHEDULER_SERVICE_NODE_PORT:$JOBSCHEDULER_SERVICE_NODE_PORT
    volumes:
      - gitgrade-jobscheduler-service:/usr/src/gitgrade/jobscheduler_service
      - gitgrade-jobscheduler-service-node-modules:/usr/src/gitgrade/jobscheduler_service/node_modules
    networks:
      - gitgrade-network
    env_file:
      - .env

  postgresql-sonarqube:
    image: postgres:13
    restart: unless-stopped
    environment:
      - POSTGRES_USER=$SONARQUBE_POSTGRES_USERNAME
      - POSTGRES_PASSWORD=$SONARQUBE_POSTGRES_PASSWORD
      - POSTGRES_DB=sonar
    volumes:
      - gitgrade-postgresql-sonarqube:/var/lib/postgresql
      - gitgrade-postgresql-sonarqube-data:/var/lib/postgresql/data
    networks:
      - gitgrade-network

  sonarqube:
    image: sonarqube:8.2-community # sonarqube:7.7-community sonarqube:8.2-community sonarqube:9.8.0-community
    security_opt:
      - seccomp:unconfined 
    restart: unless-stopped
    depends_on:
      - postgresql-sonarqube
    ports:
      - $SONARQUBE_PORT:$SONARQUBE_DOCKER_PORT
    networks:
      - gitgrade-network
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://postgresql-sonarqube:5432/sonar
      - SONAR_JDBC_USERNAME=$SONARQUBE_POSTGRES_USERNAME
      - SONAR_JDBC_PASSWORD=$SONARQUBE_POSTGRES_PASSWORD
      - sonar.es.bootstrap.checks.disable=true # don't remove this line, or app will crash without memory
      - sonar.search.javaAdditionalOpts=-Dbootstrap.system_call_filter=false
    volumes:
      - gitgrade-sonarqube-data:/opt/sonarqube/data
      - gitgrade-sonarqube-logs:/opt/sonarqube/logs
      - gitgrade-sonarqube-extensions:/opt/sonarqube/extensions
      - gitgrade-sonarqube_bundled-plugins:/opt/sonarqube/lib/bundled-plugins
      - gitgrade-repositories-volume:/usr/src/gitgrade/supportplatform_service/temp/repositories

  supportplataform-service:
    build:
      context: .
      dockerfile: ./supportplatform-service/Dockerfile
    working_dir: /usr/src/gitgrade/supportplatform_service/
    restart: unless-stopped
    depends_on:
      - mysql_gitgrade
      - sonarqube
    environment:
      - TZ=$APP_TIMEZONE
      - DB_HOST=mysql_gitgrade
      - DB_USER=$DB_USER
      - DB_PASSWORD=$DB_PASSWORD
      - DB_NAME=$DB_NAME
      - DB_PORT=$DB_DOCKER_PORT
      - HOST=$HOST
      - PORT=$SUPPORTPLATFORM_SERVICE_NODE_PORT
      - NODE_ENV=$NODE_ENV
      - APP_TIMEZONE=$APP_TIMEZONE
      - DB_DIALECT=$DB_DIALECT
      - DB_CHARSET=$DB_CHARSET
      - DB_COLLATE=$DB_COLLATE
      - DB_TIMEZONE=$DB_TIMEZONE
      - APP_DEBUG=$APP_DEBUG
      - GITHUB_ORGANIZATION_NAME=$GITHUB_ORGANIZATION_NAME
      - GITHUB_APP_CLIENT_ID=$GITHUB_APP_CLIENT_ID
      - GITHUB_APP_CLIENT_SECRET=$GITHUB_APP_CLIENT_SECRET
      - GITHUB_PERSONAL_ACCESS_TOKEN=$GITHUB_PERSONAL_ACCESS_TOKEN
      - JWT_SECRET=$JWT_SECRET
      - SESSION_SECRET=$SESSION_SECRET
      - OAUTH_SUCCESS_REDIRECT_URL=$OAUTH_SUCCESS_REDIRECT_URL
      - OAUTH_FAILURE_SEARCH_PARAM=$OAUTH_FAILURE_SEARCH_PARAM
      - SONARQUBE_HOST=sonarqube
      - SONARQUBE_PORT=$SONARQUBE_PORT
      - SONARQUBE_DOCKER_PORT=$SONARQUBE_DOCKER_PORT
      - SONARQUBE_ADMIN_USERNAME=$SONARQUBE_ADMIN_USERNAME
      - SONARQUBE_ADMIN_PASSWOR
    command: /bin/bash -c "./wait-for-it.sh --timeout=600 mysql_gitgrade:$DB_DOCKER_PORT && ./wait-for-it.sh --timeout=600 sonarqube:$SONARQUBE_DOCKER_PORT && npm run start:prod"
    ports:
      - $SUPPORTPLATFORM_SERVICE_NODE_PORT:$SUPPORTPLATFORM_SERVICE_NODE_PORT
    volumes:
      - gitgrade-supportplatform-service:/usr/src/gitgrade/supportplatform_service
      - gitgrade-supportplatform-service-node-modules:/usr/src/gitgrade/supportplatform_service/node_modules
      - gitgrade-repositories-volume:/usr/src/gitgrade/supportplatform_service/temp/repositories
    networks:
      - gitgrade-network
    env_file:
      - .env

  supportplataform-web:
    build:
      context: .
      dockerfile: ./supportplatform-web/Dockerfile
    working_dir: /usr/src/gitgrade/supportplatform_web/
    restart: unless-stopped
    depends_on:
      - mysql_gitgrade
    environment:
      - TZ=$APP_TIMEZONE
      - PORT=$SUPPORTPLATAFORM_WEB_NODE_PORT
      - SUPPORTPLATFORM_WEB_HOST=$SUPPORTPLATFORM_WEB_HOST
      - NODE_ENV=$NODE_ENV
      - APP_TIMEZONE=$APP_TIMEZONE
      - APP_DEBUG=$APP_DEBUG
      - VITE_API_URL=http://$HOST:$SUPPORTPLATFORM_SERVICE_NODE_PORT
      - VITE_OAUTH_FAILURE_SEARCH_PARAM=$OAUTH_FAILURE_SEARCH_PARAM
    command: /bin/bash -c "mkdir -p /usr/src/gitgrade/supportplatform_service/dist/temp/repositories/ && ./wait-for-it.sh --timeout=600 mysql_gitgrade:$DB_DOCKER_PORT && npm run dev"
    ports:
      - $SUPPORTPLATAFORM_WEB_NODE_PORT:$SUPPORTPLATAFORM_WEB_NODE_PORT
    volumes:
      - gitgrade-supportplatform-web:/usr/src/gitgrade/supportplataform_web
      - gitgrade-supportplatform-web-node-modules:/usr/src/gitgrade/supportplataform_web/node_modules
    networks:
      - gitgrade-network
    env_file:
      - .env

volumes:
  gitgrade-mysql-data:
  gitgrade-jobscheduler-service:
  gitgrade-jobscheduler-service-node-modules:
  gitgrade-supportplatform-service:
  gitgrade-supportplatform-service-node-modules:
  gitgrade-supportplatform-web:
  gitgrade-supportplatform-web-node-modules:
  gitgrade-postgresql-sonarqube:
  gitgrade-postgresql-sonarqube-data:
  gitgrade-sonarqube-data:
  gitgrade-sonarqube-logs:
  gitgrade-sonarqube-extensions:
  gitgrade-sonarqube_bundled-plugins:
  gitgrade-repositories-volume:


networks:
  gitgrade-network:
    driver: bridge
